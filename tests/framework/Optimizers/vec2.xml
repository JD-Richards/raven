<?xml version="1.0" ?>
<Simulation verbosity="debug">
  <TestInfo>
    <name>framework/Optimizers.Beale</name>
    <author>talbpaul</author>
    <created>2017-05-03</created>
    <classesTested>Optimizer</classesTested>
    <description>
      This test runs the optimization on Beale's function.  It tests analytic optimization values
      as well as the mechanical operation of the test.  Also tests the "gainGrowthFactor" and
      "gainShrinkFactor" convergence parameters.

      Currently the full optimization path taken for 5 trajectories is printed, and the first two
      are tested for exact path.
    </description>
    <analytic>
      This test uses Beale's function, which is documented in the analytic tests documentation under
      the Optimizer functions section.
    </analytic>
    <requirements>R-RM-1</requirements>
    <revisions>
      <revision author='talbpaul' date='2018-01-04'>added the writeSteps=every option to test default performance</revision>
    </revisions>
  </TestInfo>

  <RunInfo>
    <WorkingDir>Vector</WorkingDir>
    <Sequence>optimize,print</Sequence>
    <batchSize>1</batchSize>
  </RunInfo>

  <VariableGroups>
    <Group name="y_vars">y0,y1,y2,y3,y4,y5,y6,y7,y8,y9,y10</Group>
  </VariableGroups>

  <Steps>
    <MultiRun name="optimize">
      <Input class="DataObjects" type="PointSet">dummyIN</Input>
      <Model class="Models" type="ExternalModel">parabola</Model>
      <Optimizer class="Optimizers" type="SPSA">opter</Optimizer>
      <SolutionExport class="DataObjects" type="PointSet">opt_export</SolutionExport>
      <Output class="DataObjects" type="DataSet">optOut</Output>
    </MultiRun>
    <IOStep name="print" pauseAtEnd="True">
      <Input class="DataObjects" type="PointSet">opt_export</Input>
      <Input class="DataObjects" type="DataSet">optOut</Input>
      <Output class="OutStreams" type="Print">opt_export_vec</Output>
      <Output class="OutStreams" type="Print">opt_out_vec</Output>
    </IOStep>
  </Steps>

  <Optimizers>
    <SPSA name="opter">
      <initialization>
        <limit>2000</limit>
        <initialSeed>42</initialSeed>
        <thresholdTrajRemoval>1e-5</thresholdTrajRemoval>
        <writeSteps>every</writeSteps>
      </initialization>
      <TargetEvaluation class="DataObjects" type="PointSet">optOut</TargetEvaluation>
      <convergence>
        <gradientThreshold>1e-3</gradientThreshold>
        <relativeThreshold>1e-15</relativeThreshold>
        <gainGrowthFactor>3</gainGrowthFactor>
        <gainShrinkFactor>1.25</gainShrinkFactor>
      </convergence>
      <variable name="x">
        <upperBound>6</upperBound>
        <lowerBound>-6</lowerBound>
        <initial>-2</initial>
      </variable>
      <variable name="y0">
        <upperBound>6</upperBound>
        <lowerBound>-6</lowerBound>
        <initial>0</initial>
      </variable>
      <variable name="y1">
        <upperBound>6</upperBound>
        <lowerBound>-6</lowerBound>
        <initial>0</initial>
      </variable>
      <variable name="y2">
        <upperBound>6</upperBound>
        <lowerBound>-6</lowerBound>
        <initial>0</initial>
      </variable>
      <variable name="y3">
        <upperBound>6</upperBound>
        <lowerBound>-6</lowerBound>
        <initial>0</initial>
      </variable>
      <variable name="y4">
        <upperBound>6</upperBound>
        <lowerBound>-6</lowerBound>
        <initial>0</initial>
      </variable>
      <variable name="y5">
        <upperBound>6</upperBound>
        <lowerBound>-6</lowerBound>
        <initial>0</initial>
      </variable>
      <variable name="y6">
        <upperBound>6</upperBound>
        <lowerBound>-6</lowerBound>
        <initial>0</initial>
      </variable>
      <variable name="y7">
        <upperBound>6</upperBound>
        <lowerBound>-6</lowerBound>
        <initial>0</initial>
      </variable>
      <variable name="y8">
        <upperBound>6</upperBound>
        <lowerBound>-6</lowerBound>
        <initial>0</initial>
      </variable>
      <variable name="y9">
        <upperBound>6</upperBound>
        <lowerBound>-6</lowerBound>
        <initial>0</initial>
      </variable>
      <variable name="y10">
        <upperBound>6</upperBound>
        <lowerBound>-6</lowerBound>
        <initial>0</initial>
      </variable>
      <parameter>
        <A>50</A>
      </parameter>
      <objectVar>ans</objectVar>
    </SPSA>
  </Optimizers>

  <Models>
    <ExternalModel ModuleToLoad="time_parabola_vec" name="parabola" subType="">
      <variables>x,y_vars,ans</variables>
    </ExternalModel>
  </Models>

  <DataObjects>
    <PointSet name="dummyIN">
      <Input>x,y_vars</Input>
      <Output>OutputPlaceHolder</Output>
    </PointSet>
    <PointSet name="optOut">
      <Input>x,y_vars</Input>
      <Output>ans</Output>
    </PointSet>
    <PointSet name="opt_export">
      <Input>trajID</Input>
      <Output>x,y_vars,ans,varsUpdate</Output>
    </PointSet>
  </DataObjects>

  <OutStreams>
    <Print name="opt_export_vec">
      <type>csv</type>
      <source>opt_export</source>
      <clusterLabel>trajID</clusterLabel>
    </Print>
    <Print name="opt_out_vec">
      <type>csv</type>
      <source>optOut</source>
    </Print>
  </OutStreams>

</Simulation>
